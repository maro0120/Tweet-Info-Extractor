<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ツイート詳細取得</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #f5f8fa; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); word-break: break-all; }
        h2 { margin-top: 0; font-size: 18px; border-bottom: 2px solid #e1e8ed; padding-bottom: 10px; }
        .field { margin-bottom: 15px; }
        .label { font-weight: bold; color: #657786; font-size: 12px; display: block; margin-bottom: 4px; }
        .value { font-size: 14px; color: #14171a; white-space: pre-wrap; }
        img.preview { max-width: 100%; border-radius: 8px; margin-top: 5px; border: 1px solid #ddd; }
        .error { color: red; font-weight: bold; }
        .loading { color: #1da1f2; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ツイート情報抽出</h2>
        <div id="status" class="loading">待機中...</div>
        
        <div id="result" style="display:none;">
            <div class="field">
                <span class="label">ユーザー名</span>
                <div class="value" id="userName"></div>
            </div>
            <div class="field">
                <span class="label">Twitter ID</span>
                <div class="value" id="userId"></div>
            </div>
            <div class="field">
                <span class="label">投稿日時 (絶対時刻)</span>
                <div class="value" id="postDate"></div>
            </div>
            <div class="field">
                <span class="label">本文</span>
                <div class="value" id="bodyText"></div>
            </div>
            <div class="field">
                <span class="label">添付画像 URL</span>
                <div class="value" id="imageUrls"></div>
                <div id="imagePreviews"></div>
            </div>
            <div class="field">
                <span class="label">YouTube URL</span>
                <div class="value" id="youtubeUrl">-</div>
            </div>
            <div class="field">
                <span class="label">YouTube サムネイル</span>
                <div id="youtubeThumbPreview"></div>
            </div>
            <div class="field">
                <span class="label">元ツイートURL</span>
                <div class="value" id="originalUrl"></div>
            </div>
        </div>
    </div>

    <script>
        // Service Worker登録
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            // Share Targetは text か url パラメータにURLを入れてくることが多い
            const sharedText = params.get('text') || '';
            const sharedUrl = params.get('url') || '';
            
            // テキスト内からURLを探す正規表現
            const urlRegex = /(https?:\/\/(?:twitter\.com|x\.com)\/[a-zA-Z0-9_]+\/status\/[0-9]+)/;
            const match = (sharedUrl + " " + sharedText).match(urlRegex);

            if (match) {
                const tweetUrl = match[0];
                document.getElementById('originalUrl').textContent = tweetUrl;
                fetchTweetData(tweetUrl);
            } else {
                document.getElementById('status').textContent = "TwitterのURLが見つかりませんでした。共有メニューからツイートを共有してください。";
            }
        });

        async function fetchTweetData(url) {
            document.getElementById('status').textContent = "データ取得中...";
            
            try {
                // URLからツイートIDとユーザー名を抽出
                // 形式: https://x.com/username/status/123456789
                const parts = url.split('/');
                const tweetId = parts[parts.length - 1].split('?')[0]; // クエリパラメータ除去
                
                // FixTweet APIを使用 (非公式ですが強力なAPIです)
                const apiUrl = `https://api.fxtwitter.com/status/${tweetId}`;
                
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                const tweet = data.tweet;

                renderData(tweet, url);

            } catch (e) {
                console.error(e);
                document.getElementById('status').innerHTML = `<span class="error">取得に失敗しました。<br>エラー: ${e.message}</span>`;
            }
        }

        function renderData(tweet, originalUrl) {
            document.getElementById('status').style.display = 'none';
            document.getElementById('result').style.display = 'block';

            // 1. ユーザー名
            document.getElementById('userName').textContent = tweet.author.name;

            // 2. Twitter ID
            document.getElementById('userId').textContent = `@${tweet.author.screen_name}`;

            // 3. 投稿日時 (Unix Timeから変換)
            // tweet.created_at は ISO形式 または timestamp
            const date = new Date(tweet.created_timestamp * 1000); 
            document.getElementById('postDate').textContent = date.toLocaleString('ja-JP');

            // 4. 本文
            document.getElementById('bodyText').textContent = tweet.text;

            // 5. 添付画像
            const imgContainer = document.getElementById('imagePreviews');
            const imgUrlContainer = document.getElementById('imageUrls');
            imgContainer.innerHTML = '';
            imgUrlContainer.textContent = '';
            
            if (tweet.media && tweet.media.photos) {
                tweet.media.photos.forEach(photo => {
                    // URL表示
                    const p = document.createElement('div');
                    p.textContent = photo.url;
                    imgUrlContainer.appendChild(p);
                    
                    // プレビュー表示
                    const img = document.createElement('img');
                    img.src = photo.url;
                    img.className = 'preview';
                    imgContainer.appendChild(img);
                });
            } else {
                imgUrlContainer.textContent = "なし";
            }

            // 6. YouTube URL & 7. サムネイル
            // 本文中のURLまたはentitiesからYouTubeを探す
            let ytUrl = "-";
            let ytThumb = "";
            
            // FixTweetのAPIレスポンスに含まれるURLを走査するか、テキストから正規表現で抽出
            // 本文から簡易抽出
            const ytRegex = /(https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11}))/;
            const ytMatch = tweet.text.match(ytRegex);

            if (ytMatch) {
                ytUrl = ytMatch[0];
                const videoId = ytMatch[2];
                // サムネイルの高画質版を生成
                ytThumb = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                
                document.getElementById('youtubeUrl').textContent = ytUrl;
                
                const thumbImg = document.createElement('img');
                thumbImg.src = ytThumb;
                thumbImg.className = 'preview';
                document.getElementById('youtubeThumbPreview').appendChild(thumbImg);
            } else {
                document.getElementById('youtubeUrl').textContent = "なし";
                document.getElementById('youtubeThumbPreview').textContent = "なし";
            }
        }
    </script>
</body>
</html>
